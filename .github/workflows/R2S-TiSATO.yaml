name: R2S-LEDE

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-20.04
    if: github.event.repository.owner.id == github.event.sender.id

    steps:
    - name: Checkout
      uses: actions/checkout@main
    - name: Show system
      run: |
        echo -e "Total CPU cores\t: $(nproc)"
        cat /proc/cpuinfo | grep 'model name'
        free -h
        uname -a
        [ -f /proc/version ] && cat /proc/version
        [ -f /etc/issue.net ] && cat /etc/issue.net
        [ -f /etc/issue ] && cat /etc/issue
        ulimit -a

    - name: Free disk space
      run: |
        df -h
        cp -r ./scripts/. .
        echo "Cleaning disk..."
        bash 90-DiskFree.sh > /dev/null 2>&1
        df -h

    - name: Init build dependencies
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E rm -rf /etc/apt/sources.list.d
        sudo -E apt-get update -y
        sudo -E apt-get install -y build-essential rsync asciidoc binutils bzip2 gawk gettext git libncurses5-dev libz-dev patch unzip zlib1g-dev lib32gcc1 libc6-dev-i386 subversion flex uglifyjs git-core p7zip p7zip-full msmtp libssl-dev texinfo libreadline-dev libglib2.0-dev xmlto qemu-utils upx libelf-dev autoconf automake libtool autopoint ccache curl wget vim nano python3 python3-pip python3-ply haveged lrzsz device-tree-compiler scons
        wget -qO - https://raw.githubusercontent.com/friendlyarm/build-env-on-ubuntu-bionic/master/install.sh | sed 's/python-/python3-/g' | /bin/bash
        sudo -E apt-get clean -y
        git config --global user.name 'GitHub Actions' && git config --global user.email 'noreply@github.com'

    - name: PreCompile
      run: |
        df -h
        sudo chown -R runner:runner /home/runner/work
        cp -r ./scripts/. .
        /bin/bash 01-GetRepo.sh

    - name: Prepare Package
      run: |
        cd lede
        cp -r ../scripts/. .
        /bin/bash 02-Package.sh

    - name: Make Config
      run: |
        cd lede
        mv ../seeds .config
        #echo -e 'CONFIG_DEVEL=y\nCONFIG_CCACHE=y' >> .config
        make defconfig

    # - name: Cache
    #   uses: klever1988/cachewrtbuild@test
    #   with:
    #     ccache: 'true'
    #     mixkey: ${{ env.TARGET_DEVICE_ARCH }}
    #     prefix: ${{ github.workspace }}/lede

    - name: Cache Build
      uses: actions/cache@v3
      with:
        key: TiSATO
        path: |
          lede/tools
          lede/toolchain
          lede/target
          lede/staging_dir
          lede/build_dir

    - name: Make Download
      run: |
        df -h
        cd lede
        make download -j$(($(nproc) + 1))

    - name: Compile
      id: compileopenwrt
      continue-on-error: true
      run: |
        df -h
        cd lede
        # make -j$(($(nproc) + 1)) || make -j$(($(nproc) + 1)) V=s
        make -j$(($(nproc) + 1))
        echo $?

    - name: If Error
      if: steps.compileopenwrt.outcome == 'failure'
      continue-on-error: true
      run: |
        df -h
        cat lede/.config
        echo '================================================================'
        cd lede && make -j1 V=s

    - name: Print Disk Space After
      run: df -h

    - name: Organize files
      id: organize
      run: |
        rm -rf ./artifact/
        mkdir -p ./artifact/
        mv lede/bin/targets/rockchip/armv8/*sysupgrade.img* ./artifact/
        cd ./artifact/
        ls -Ahl
        gzip -d *.gz && exit 0
        gzip --best *.img
        ls -Ahl
        # sha256sum lede*r2s* | tee R2S-TiSATO-$(date +%Y-%m-%d)-${{ env.rls_tag }}.sha256sum
        # zip R2S-TiSATO-$(date +%Y-%m-%d)-${{ env.rls_tag }}-ext4.zip *r2s*ext4*
        zip R2S-TiSATO-$(date +%Y-%m-%d)-${{ env.rls_tag }}-sfs.zip *r2s*squashfs*
        ls -Ahl

    - name: Upload artifact
      uses: actions/upload-artifact@main
      with:
        name: TiSATO_${{ env.rls_tag }}
        path: ./artifact/

    - name: Create release
      id: create_release
      uses: ncipollo/release-action@v1.8.0
      with:
        name: TiSATO_${{ env.rls_tag }}
        allowUpdates: true
        tag: ${{ env.rls_tag }}
        commit: master
        replacesArtifacts: true
        token: ${{ secrets.GITHUB_TOKEN }}
        artifacts: ./artifact/*.gz